<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 3D Studio - Universal</title>
    <style>
        :root { --accent: #f57d00; --bg: #0a0a0a; --quest: #0084ff; --xreal: #673ab7; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: sans-serif; display: flex; justify-content: center; padding: 20px; }
        #studio { width: 100%; max-width: 450px; text-align: center; }
        .preview-box { width: 100%; height: 250px; background: #000; border-radius: 12px; margin: 15px 0; border: 1px solid #333; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        canvas { max-width: 100%; max-height: 100%; }
        
        .btn { background: var(--accent); color: #fff; border: none; padding: 15px; border-radius: 10px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 10px; text-transform: uppercase; }
        .btn-xreal { background: var(--xreal); display: none; }
        .btn-quest { background: var(--quest); display: none; }
        .btn-secondary { background: #333; }
        
        #status { font-size: 13px; color: #03a9f4; margin: 10px 0; min-height: 20px; }
        #xreal-output { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 9999; }
        #xreal-output canvas { width: 100%; height: 100%; object-fit: contain; }
    </style>
</head>
<body>

<div id="studio">
    <h2>AI 3D <span style="color:var(--accent)">STUDIO</span></h2>
    <input type="file" id="fileInput" hidden accept="image/*">
    <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">Pick 2D Photo</button>
    
    <div class="preview-box">
        <canvas id="main-cvs"></canvas>
    </div>

    <div id="status">Ready</div>
    <button class="btn" id="goBtn">Convert to 3D</button>
    
    <button class="btn btn-xreal" id="xrealBtn">FULL REVIEW (XREAL)</button>
    
    <button class="btn btn-quest" id="questBtn">VIEW IN VR (QUEST)</button>
    
    <button class="btn btn-secondary" id="dlBtn" style="display:none;">Download SBS Image</button>
</div>

<div id="xreal-output" onclick="exitFullscreen()">
    <canvas id="sbs-final"></canvas>
</div>

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1';

    const fileInput = document.getElementById('fileInput');
    const mainCvs = document.getElementById('main-cvs');
    const sbsFinal = document.getElementById('sbs-final');
    const status = document.getElementById('status');
    const xrealBtn = document.getElementById('xrealBtn');
    const questBtn = document.getElementById('questBtn');

    let aiEngine = null;
    let originalImg = null;

    fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        originalImg = new Image();
        originalImg.src = URL.createObjectURL(file);
        originalImg.onload = () => {
            mainCvs.width = originalImg.width;
            mainCvs.height = originalImg.height;
            mainCvs.getContext('2d').drawImage(originalImg, 0, 0);
        };
    };

    document.getElementById('goBtn').onclick = async () => {
        status.innerText = "Processing AI Depth...";
        if (!aiEngine) aiEngine = await pipeline('depth-estimation', 'Xenova/depth-anything-small-hf');
        
        const result = await aiEngine(originalImg.src);
        const depth = await result.depth.resize(originalImg.width, originalImg.height);
        
        generateSBS(originalImg, depth);
        
        status.innerText = "3D Ready!";
        xrealBtn.style.display = "block";
        questBtn.style.display = "block";
        document.getElementById('dlBtn').style.display = "block";
    };

    function generateSBS(img, depth) {
        const w = img.width; const h = img.height;
        sbsFinal.width = 3840; sbsFinal.height = 1080;
        const fCtx = sbsFinal.getContext('2d');
        
        // 3D Logic: Shift pixels based on depth map
        const tempC = document.createElement('canvas');
        tempC.width = w; tempC.height = h;
        const tCtx = tempC.getContext('2d');
        tCtx.drawImage(img, 0, 0);
        const srcData = tCtx.getImageData(0, 0, w, h);
        const left = fCtx.createImageData(w, h);
        const right = fCtx.createImageData(w, h);

        for (let i = 0; i < w * h; i++) {
            const shift = (depth.data[i] / 255) * 15;
            const x = i % w; const y = Math.floor(i / w);
            const lx = Math.max(0, Math.min(w - 1, Math.floor(x + shift)));
            const rx = Math.max(0, Math.min(w - 1, Math.floor(x - shift)));
            const oIdx = i * 4;
            const lIdx = (y * w + lx) * 4; const rIdx = (y * w + rx) * 4;
            for(let j=0; j<4; j++) {
                left.data[oIdx+j] = srcData.data[lIdx+j];
                right.data[oIdx+j] = srcData.data[rIdx+j];
            }
        }
        
        const cL = document.createElement('canvas'); cL.width = w; cL.height = h;
        cL.getContext('2d').putImageData(left, 0, 0);
        const cR = document.createElement('canvas'); cR.width = w; cR.height = h;
        cR.getContext('2d').putImageData(right, 0, 0);

        fCtx.fillStyle = "black"; fCtx.fillRect(0, 0, 3840, 1080);
        fCtx.drawImage(cL, 0, 0, w, h, 0, 0, 1920, 1080);
        fCtx.drawImage(cR, 0, 0, w, h, 1920, 0, 1920, 1080);
    }

    // --- XREAL MODE (HARDWARE SBS) ---
    xrealBtn.onclick = () => {
        const out = document.getElementById('xreal-output');
        out.style.display = "block";
        out.requestFullscreen?.() || out.webkitRequestFullscreen?.();
    };

    window.exitFullscreen = () => {
        document.exitFullscreen?.();
        document.getElementById('xreal-output').style.display = "none";
    };

    // --- QUEST MODE (WEBXR) ---
    questBtn.onclick = async () => {
        if (!navigator.xr) return alert("WebXR not found. Use Meta Quest Browser.");
        
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 100);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.xr.enabled = true;

        const texture = new THREE.CanvasTexture(sbsFinal);
        const material = new THREE.MeshBasicMaterial({ map: texture });
        const screen = new THREE.Mesh(new THREE.PlaneGeometry(4, 1.12), material);
        screen.position.set(0, 1.6, -3);
        scene.add(screen);

        const session = await navigator.xr.requestSession('immersive-vr');
        renderer.xr.setSession(session);
        renderer.setAnimationLoop(() => renderer.render(scene, camera));
    };
</script>
</body>
</html>
