<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 3D Fast Studio</title>
    <style>
        :root { --accent: #f57d00; --bg: #0a0a0a; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: sans-serif; display: flex; justify-content: center; padding: 20px; }
        #studio { width: 100%; max-width: 500px; text-align: center; }
        
        /* Preview Area with Scanner */
        .preview-box { 
            width: 100%; min-height: 250px; background: #000; border-radius: 12px; 
            margin: 15px 0; border: 1px solid #333; overflow: hidden; position: relative;
            display: flex; align-items: center; justify-content: center;
        }
        canvas, video { max-width: 100%; height: auto; display: block; }

        /* Scanning Animation */
        #ai-loader { display: none; position: absolute; width: 100%; height: 100%; top: 0; left: 0; background: rgba(0,0,0,0.8); flex-direction: column; align-items: center; justify-content: center; z-index: 10; }
        .scanner { width: 90%; height: 3px; background: var(--accent); box-shadow: 0 0 20px var(--accent); position: absolute; animation: scan 1.5s infinite ease-in-out; }
        @keyframes scan { 0% { top: 5%; } 50% { top: 95%; } 100% { top: 5%; } }
        .ai-text { margin-top: 50px; font-family: monospace; color: var(--accent); font-weight: bold; }

        .btn { background: var(--accent); color: #fff; border: none; padding: 16px; border-radius: 10px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 10px; text-transform: uppercase; }
        .btn-secondary { background: #222; margin-bottom: 5px; }
        #status { font-size: 12px; color: #888; margin: 10px 0; }
    </style>
</head>
<body>

<div id="studio">
    <h2>AI 3D <span style="color:var(--accent)">FAST STUDIO</span></h2>
    
    <input type="file" id="mediaInput" hidden accept="image/*,video/*">
    <button class="btn btn-secondary" onclick="document.getElementById('mediaInput').click()">CHOOSE PHOTO OR VIDEO</button>
    
    <div class="preview-box">
        <div id="ai-loader">
            <div class="scanner"></div>
            <div id="loader-text" class="ai-text">ANALYZING DEPTH...</div>
        </div>
        <video id="raw-video" style="display:none" muted playsinline></video>
        <canvas id="main-cvs"></canvas>
    </div>

    <div id="status">Ready</div>
    <button class="btn" id="goBtn">START CONVERSION</button>
    <button class="btn btn-secondary" id="dlBtn" style="display:none; margin-top:20px;">DOWNLOAD .MP4 3D</button>
</div>

<script type="module">
    import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1';

    const loader = document.getElementById('ai-loader');
    const lText = document.getElementById('loader-text');
    const mediaInput = document.getElementById('mediaInput');
    const vid = document.getElementById('raw-video');
    const cvs = document.getElementById('main-cvs');
    const ctx = cvs.getContext('2d', { willReadFrequently: true });
    const goBtn = document.getElementById('goBtn');
    const dlBtn = document.getElementById('dlBtn');

    let aiEngine = null;
    let mode = 'image';
    let videoBlobUrl = null;

    mediaInput.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        mode = file.type.startsWith('image') ? 'image' : 'video';
        const url = URL.createObjectURL(file);
        
        if (mode === 'image') {
            const img = new Image(); img.src = url;
            img.onload = () => { cvs.width = img.width; cvs.height = img.height; ctx.drawImage(img, 0, 0); cvs.dataset.original = url; };
            vid.style.display = 'none'; cvs.style.display = 'block';
        } else {
            vid.src = url; vid.style.display = 'block'; cvs.style.display = 'none';
            vid.onloadedmetadata = () => { cvs.width = vid.videoWidth; cvs.height = vid.videoHeight; };
        }
        dlBtn.style.display = 'none';
    };

    goBtn.onclick = async () => {
        loader.style.display = 'flex';
        goBtn.disabled = true;
        if (!aiEngine) aiEngine = await pipeline('depth-estimation', 'Xenova/depth-anything-small-hf');

        if (mode === 'image') {
            processImage();
        } else {
            processVideo();
        }
    };

    async function processImage() {
        const img = new Image(); img.src = cvs.dataset.original;
        img.onload = async () => {
            const res = await aiEngine(img.src);
            const depth = await res.depth.resize(img.width, img.height);
            cvs.width = img.width * 2;
            draw3D(img, depth, img.width, img.height);
            finish();
        };
    }

    async function processVideo() {
        const w = vid.videoWidth; const h = vid.videoHeight;
        cvs.width = w * 2; cvs.height = h;
        cvs.style.display = 'block'; vid.style.display = 'none';

        const stream = cvs.captureStream(24); // Output is 24fps
        const recorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' });
        const chunks = [];
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
            videoBlobUrl = URL.createObjectURL(new Blob(chunks, { type: 'video/mp4' })); // Label as mp4 for XREAL compatibility
            finish();
        };
        
        recorder.start();
        vid.currentTime = 0;
        
        // SPEED OPTIMIZATION: Process at 8fps (every 0.125s) to save time
        const step = 0.125; 
        while (vid.currentTime < vid.duration) {
            const temp = document.createElement('canvas'); temp.width = w; temp.height = h;
            temp.getContext('2d').drawImage(vid, 0, 0);
            
            const res = await aiEngine(temp.toDataURL('image/jpeg', 0.7));
            draw3D(temp, await res.depth.resize(w, h), w, h);
            
            lText.innerText = `AI SCANNING: ${Math.round((vid.currentTime / vid.duration) * 100)}%`;
            vid.currentTime += step;
            await new Promise(r => vid.onseeked = r);
        }
        recorder.stop();
    }

    function draw3D(source, depth, w, h) {
        const intensity = 15;
        const tempC = document.createElement('canvas');
        tempC.width = w; tempC.height = h;
        const tCtx = tempC.getContext('2d');
        tCtx.drawImage(source, 0, 0);
        const srcData = tCtx.getImageData(0, 0, w, h);
        const left = ctx.createImageData(w, h); const right = ctx.createImageData(w, h);

        for (let i = 0; i < w * h; i++) {
            const shift = (depth.data[i] / 255) * intensity;
            const x = i % w; const y = Math.floor(i / w);
            const lx = Math.max(0, Math.min(w - 1, Math.floor(x + shift/2)));
            const rx = Math.max(0, Math.min(w - 1, Math.floor(x - shift/2)));
            const oIdx = i * 4; const lIdx = (y * w + lx) * 4; const rIdx = (y * w + rx) * 4;
            for(let j=0; j<4; j++) { left.data[oIdx+j] = srcData.data[lIdx+j]; right.data[oIdx+j] = srcData.data[rIdx+j]; }
        }
        ctx.putImageData(left, 0, 0); ctx.putImageData(right, w, 0);
    }

    function finish() {
        loader.style.display = 'none';
        goBtn.disabled = false;
        dlBtn.style.display = 'block';
        lText.innerText = "ANALYZING DEPTH...";
    }

    dlBtn.onclick = () => {
        const a = document.createElement('a');
        a.href = mode === 'image' ? cvs.toDataURL() : videoBlobUrl;
        a.download = mode === 'image' ? "3D_PHOTO_SBS.png" : "3D_VIDEO_SBS.mp4";
        a.click();
    };
</script>
</body>
</html>
